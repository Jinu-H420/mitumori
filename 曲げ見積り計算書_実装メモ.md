# 曲げ見積り計算書（曲げ工賃のみ）— 実装メモ・Claude Code 用

**Claude Code で曲げ見積り計算書を触るときは、このファイルを読み込むこと。**

---

## 1. ファイルと役割

| ファイル | 役割 |
|:---|:---|
| **曲げ見積り計算書.html** | 曲げ工賃だけを検算する単体の計算書。材料費・穴あけ・切断費は含まない。寸法入力で重量・長さを自動計算し、形状・数量・オプションで曲げ工賃を出す。 |
| **index.html** | トップページ。「曲げ見積り計算書を開く」→ 曲げ見積り計算書.html、「見積り計算書を開く」→ 見積り計算書.html（材料費込みの本見積） |

- **曲げ見積り計算書** = 曲げだけ・検算用。あとで材料費見積りと合算する想定。
- **見積り計算書.html** = 材料費＋切断＋曲げ＋穴あけの全体（別仕様。見積り計算書_仕様まとめ.md 参照）。

---

## 2. 曲げ見積り計算書.html の画面構成

- **寸法**: 板厚（鉄・select）／縦L／横W／余長 → 重量・長さを自動計算（鉄 7.85、長さ＝max(縦+余長, 横+余長)）。
- **入力**: **重量≤1kg かつ 曲げ長さ≤300mm** のとき自動で小物扱いになり、**曲げ回数**（1〜8回）と**数量**（下の「数量」欄）で工賃を計算。曲げ回数ごとの基準単価に数量係数（1〜4個×1.5、5〜19個×1.0、20個〜×0.8）をかけ、合計は最低300円。それ以外は 形状（L曲げ／Z／コの字／C型／三方／四方／ハット）、数量、重量・長さ（直接入力用）、オプション（数量係数反映、中押し、逆曲げ、長尺目押し、深曲げ）。
- **曲げ工賃内訳**: 基準価格 → 数量係数 → 数量補正後 → 小物割引 → 小物後（最低300円）→ オプション加算 → 合計。
- **選択中の形状の表**: 重量帯×長さ区分の基準価格を一覧表示。**セル編集可能**。編集した値は **localStorage** に保存され、次回以降も反映される。

---

## 3. 板厚（鉄）

- **入力は select（ドロップダウン）**。数値入力ではない。
- 選択肢（mm）: —（未選択）, 1, 1.2, 1.6, 2, 2.3, 3.2, 4.5, 6, 9, 12, 16。
- 未選択のときは寸法から重量を計算しない（直接入力の重量・長さを使う）。

---

## 4. 価格表（BENDING_TABLE）と長さ区分

- **LENGTH_THRESHOLDS**: `[500, 835, 1670, 2505, 3048, 99999]` → 列は 〜500mm, 〜835mm, 〜1670mm, 〜2505mm, 〜3048mm, 3048mm超（計6列）。
- **BENDING_TABLE**: 各行は `{ shape, w, c }`。`w` は重量上限(kg)（10, 20, 30, 50, 80, 100, 150, 9999）。`c` は長さ6区分の単価配列。
- 形状: L曲げ、コの字曲げ、Z曲げ、C型曲げ、ハット曲げ、**三方曲げ、四方曲げ**（計7形状）。複数曲げのみ C型曲げ にマッピング（shapeMap）。三方・四方は 2026-02 の Excel（曲げ工賃_入力表_基本7パターン_v2.xlsx）を機に独自エントリに分離。
- **コの字/Z曲げ**: 〜500mm と 〜835mm 列は同値（Excel の「300〜835mm」列を両列に適用）。

---

## 5. 計算ロジック（要約）

- **小物**（重量≤1kg かつ 曲げ長さ≤300mm で**自動判定**）: 表引きは行わず、**曲げ回数**（1〜8回）ごとの基準単価（KOMONO_BEND_TABLE: 1回=400円、2回=500、3回=600、4回=800、5回=1000、6回=1200、7回=1500、8回=1800）に**数量係数**（1〜4個×1.5、5〜19個×1.0、20個〜×0.8）をかけ、× 数量。**最低300円**。中押し等オプションは適用しない。右側に曲げ回数→基準単価の表を表示。
- **通常**（上記以外）:
1. **基準価格**: 形状・重量・長さで BENDING_TABLE（実際は **currentBendingTable**）から表引き。重量は「入力重量以上の最小 w」の行、長さは「入力長さ以下の最小しきい値」の列。
2. **数量係数**: チェックON時のみ適用。1〜4個×1.5、5〜19個×1.0、20個〜×0.8。OFF時は常に1.0。
3. **小物割引**: 長辺≤300mm かつ 重量≤1.0kg のとき ×0.8。ただし **最低300円**。
4. **オプション**: 中押し×1.5、逆曲げ×1.2、長尺目押し+2,500円（長さ≥1000mm）、深曲げ+3,000円。

---

## 6. 選択中の形状の表（編集と保存）

- 表のセルは **input type="number"**。変更すると **currentBendingTable** を更新し、**localStorage**（キー: `bending-estimate-price-table`）に保存する。
- 起動時に localStorage から読み込み、形式が BENDING_TABLE と一致すれば **currentBendingTable** の初期値にする。一致しなければ BENDING_TABLE のコピーで初期化。
- セル編集時のイベントは **tbody に委譲**。各 input に `data-row` と `data-col` を付け、change で「どのセルか」を特定してから currentBendingTable を更新している（クロージャでセルを特定すると再描画でずれるため、data 属性＋委譲に変更済み）。

---

## 7. 変更時の注意（Claude Code で触る場合）

- **BENDING_TABLE** の行数・形状名・`w` の並びを変えると、**loadBendingTable** の検証で不一致になり、localStorage は使われず BENDING_TABLE のコピーで初期化される。列数（`c.length`）も LENGTH_THRESHOLDS.length と一致させること。
- 曲げ見積り計算書.html は **見積り計算書.html** とは別ファイル・別ロジック。見積り計算書_仕様まとめ.md の曲げ部分と単価表の定義が異なるので、どちらの計算書をいじっているか区別すること。
- index.html の「曲げ見積り計算書を開く」のリンク先は **曲げ見積り計算書.html**（相対パス）。同じフォルダにないと開けない。

---

## 8. 関連ドキュメント

- **見積り計算書_仕様まとめ.md** — 材料費込みの「見積り計算書.html」の仕様。
- **曲げ加工見積もりシステム_実装仕様書_v3.0.md** — 曲げ工賃の3段階ロジック（表引き・係数・固定費）の仕様。
- **進捗確認_曲げ見積り.md** — evals と見積り計算書.html の進捗。曲げ見積り計算書.html 単体の evals は未整備。
