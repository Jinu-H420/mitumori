# 曲げ加工賃 計算ロジック — Gemini仕様と現行実装の比較

Gemini がまとめた「3段階の計算」と、`見積り計算書.html` の実装を対応づけて比較したものです。

---

## 重要：HTMLには「曲げ工賃」が2系統ある

| 系統 | 使う場所 | 計算の仕方 |
|:---|:---|:---|
| **メイン（本見積）** | 左「計算過程」の曲げ工賃・右「見積内訳」の曲げ工賃・見積合計 | **曲げkg単価 × 重量**。kg単価は板厚別デフォルト or 手入力。表引きは**参考用**（U20/O20）のみ。 |
| **v2.1（加工工賃のみ）** | 右パネル「加工工賃のみ（v2.1・材料費含まず）」ブロック | **基準価格の表引き** → 数量係数 → 小物係数 → 最低300円。Gemini の3段階に**相当**。 |

**見積合計に効いているのはメイン（kg単価×重量）**です。v2.1 は「加工工賃だけの参考値」として別表示です。

---

## 1. 基準価格の決定（形状×重量×曲げ長さ）

| Gemini 仕様 | 現行実装 | 一致 |
|:---|:---|:---:|
| 計算式ではなく**価格表（マトリックス）**から数値を拾う | **v2.1** で `BENDING_TABLE_V21` を参照。形状×重量×長さ区分で表引き。 | ✅ v2.1 と一致 |
| 入力: 形状 × 製品重量 × 曲げ長さ | `getBasePriceV21(shape, wt, lengthMm)`。重量は `w`（10,20,30…kg）、長さは 835/1670/2505/3048mm で区分。 | ✅ |
| 参照: 工賃入力表 (2).csv | 同じ数値が `data/曲げ価格表.csv` および HTML 内 `BENDING_TABLE_V21` にあり。 | ✅ データは同一 |
| No.1 L曲げ / No.2 コの字・Z / No.4 C型・ハット / No.5 三方・四方 | L・コの字・Z・C型・ハットをそのまま表に持つ。三方・四方は **C型曲げ** として同じ行を参照（`shapeForV21`）。 | ✅ 形状対応は同じ考え方 |

**メインの曲げ工賃**は表引きをしていません。**kg単価×重量**のみで、U20/O20 は「参考テーブル」の説明用です。

---

## 2. 係数による補正（掛け率）

### A. 数量（ロット）補正

| Gemini 仕様 | 現行実装 | 一致 |
|:---|:---|:---:|
| 1〜4個: ×1.5 | `quantityFactorV21(qty)` → 1.5 | ✅ |
| 5〜19個: ×1.0 | → 1.0 | ✅ |
| 20個以上: ×0.8 | → 0.8 | ✅ |

**v2.1 のみ**で使用。メインの曲げ工賃には数量係数なし。

---

### B. 小物・軽量品割引

| Gemini 仕様 | 現行実装 | 一致 |
|:---|:---|:---:|
| 条件: 長辺300mm以下 **かつ** 重量1kg以下 | `longSide<=300 && wt<=1.0` のとき `smallF=0.8` | ✅ |
| 処理: 合計から ×0.8 | 基準×数量係数 のあとに × smallF | ✅ |
| 最低料金 300円 | `Math.max(300, Math.round(bendV21*smallF))` | ✅ |

**v2.1 のみ**で使用。

---

### C. 難易度・特殊加工補正

| Gemini 仕様 | 現行実装 | 一致 |
|:---|:---|:---:|
| 中押し曲げ (Nakagoshi): ×1.5 | **未実装**（入力項目・係数なし） | ❌ |
| 逆曲げ (Reverse): ×1.2 | **未実装**（入力項目・係数なし） | ❌ |

---

## 3. 固定費の加算（チャージ）

| Gemini 仕様 | 現行実装 | 一致 |
|:---|:---|:---:|
| 長尺目押し（長さ1m以上で目押し指定）: +2,500円 | **未実装**（入力・加算なし） | ❌ |
| 深曲げ・干渉回避: +3,000円 | **未実装**（入力・加算なし） | ❌ |

---

## 4. まとめ表（実装状況）

| 項目 | Gemini 3段階 | メイン曲げ工賃 | v2.1 加工工賃のみ |
|:---|:---|:---|:---|
| 基準価格 | 表（CSV）から取得 | **使わない**（kg単価×重量） | ✅ 表引き（BENDING_TABLE_V21） |
| 数量補正 1.5/1.0/0.8 | あり | なし | ✅ あり |
| 小物割引 ×0.8・最低300円 | あり | なし | ✅ あり |
| 中押し ×1.5 | あり | なし | ❌ 未実装 |
| 逆曲げ ×1.2 | あり | なし | ❌ 未実装 |
| 長尺目押し +2,500円 | あり | なし | ❌ 未実装 |
| 深曲げ・干渉回避 +3,000円 | あり | なし | ❌ 未実装 |

---

## 5. 結論と使い分け

- **Gemini の「3段階」ロジック**は、**v2.1（加工工賃のみ）** にかなり近いです。  
  - 基準価格の表引き（形状×重量×長さ）  
  - 数量補正・小物割引・最低300円  
  までが実装済みです。
- **未実装**なのは次の4つです。  
  - 中押し ×1.5  
  - 逆曲げ ×1.2  
  - 長尺目押し +2,500円  
  - 深曲げ・干渉回避 +3,000円  
  これらを入れたい場合は、v2.1 ブロックに「チェック＋係数/固定費」を追加する形が自然です。
- **本見積の金額（見積合計）** は、いまは **メインの曲げ工賃（kg単価×重量）** で決まっており、表引きや数量・小物補正は使っていません。  
  「社長の価格表で決める」運用に寄せるなら、**見積合計に v2.1 の曲げ部分を採用する**か、メイン曲げを「表引き＋係数」に差し替える設計が必要です。

以上が、Gemini まとめと現行実装の比較です。
