# 曲げ加工見積もりシステム 実装仕様書 (v3.0)

このドキュメントは、材料費を含まない**「純粋な加工工賃（曲げ＋穴あけ）」**の計算ロジックを定義したものです。計算の基準として、CSV ファイル **bending_price_table.csv**（価格表）を使用します。

---

## 1. 計算ロジック詳細

### A. 曲げ加工費 (Bending Cost)

#### 1. 基準価格の取得 (Base Price)

- 入力された **形状**、**重量(kg)**、**長さ(mm)** に合致する価格を CSV から取得する。
- **データソース**: `src/data/bending_price_table.csv`  
  （同一データを `data/曲げ価格表.csv` でも保持。HTML 内では `BENDING_TABLE_V21` として埋め込み可）

**検索ロジック**

| 項目 | ルール |
|:---|:---|
| **重量** | 入力重量 ≤ テーブル重量 となる**最小**の行を選択。該当がなければ最大重量の行を使用。 |
| **長さ** | 入力長さ ≤ テーブル長さ となる**最小**の列を選択。該当がなければ最大長さの列を使用。 |

※ CSV の最大値を超える場合は、最大値の価格を適用する（またはエラー処理）。

**長さ閾値（テーブル列）**

- 835mm, 1670mm, 2505mm, 3048mm, 3048mm超（列名: 〜835mm, 〜1670mm, 〜2505mm, 〜3048mm, 3048mm超）

**形状パターン（価格表の対応）**

| No. | 形状 | 備考 |
|:---|:---|:---|
| 1 | L曲げ | 基準 |
| 2 | コの字曲げ | — |
| 3 | Z曲げ | — |
| 4 | C型曲げ | — |
| 11 | ハット曲げ | C型曲げと同単価表を参照可 |
| 5. 三方曲げ / 8. 四方曲げ | C型曲げとして同一行を参照 | 実装時は形状を「C型曲げ」にマッピング |

---

#### 2. 数量スライド補正 (Volume Discount)

製造個数（Lot）に応じて、基準価格に係数を掛ける。

| 個数 | 係数 | 意味 |
|:---|:---|:---|
| 1 〜 4個 | × 1.5 | 段取り負担増 |
| 5 〜 19個 | × 1.0 | 標準 |
| 20個以上 | × 0.8 | 量産割引 |

---

#### 3. 小物・軽量品割引 (Small Part Discount)

以下の条件を**すべて満たす**場合、さらに割引を適用する。

| 項目 | 内容 |
|:---|:---|
| **条件** | 長辺 ≤ 300mm **かつ** 重量 ≤ 1.0 kg |
| **処理** | 小計（数量補正後） × 0.8 |
| **下限** | 計算結果が 300円 を下回る場合は、**300円**とする。 |

---

#### 4. 難易度・オプション加算 (Complexity Add-ons)

基準価格（数量補正後）に対して、以下の係数または固定額を加算する。

| オプション | 条件・処理 |
|:---|:---|
| **中押し (Nakagoshi)** | × 1.5 |
| **逆曲げ (Reverse Bend)** | × 1.2 |
| **長尺目押し** | 長さ ≥ 1000mm **かつ** 目押し指定時 → **+2,500円** |
| **深曲げ・干渉回避** | **+3,000円** |

※ 複数該当する場合は、それぞれを順に適用する（仕様で乗算・加算の順序を規定すること）。

---

### B. 穴あけ加工費 (Hole / Pierce Cost)

加工工賃（曲げ＋穴あけ）のうち、穴あけ分は以下の種類ごとに単価×個数で合算する。

| 種類 | 単価 | 備考 |
|:---|:---|:---|
| **丸穴（30φ未満）** | 50円/個 | 固定 |
| **長穴** | 70円/個 | 固定 |
| **丸穴（30φ以上）** | 板厚別（円/個） | 穴径30mm以上のみ対象。板厚帯に応じて 50〜270円等（`data/hole_prices.json` 丸穴_標準または HTML 内 `HOLE_MARU30_BY_T` に準拠） |
| **ポンチ (Marking)** | 30円/個 | 全板厚一律 |
| **ピアス (Piercing)** | 板厚別（円/個） | 〜t2.3: 30／〜t4.5: 60／〜t6: 30／〜t9: 100／〜t12: 150／t12超: 200 |

**穴あけ合計** = 丸穴(30φ未満) + 長穴 + 丸穴(30φ以上) + ポンチ + ピアス

---

## 2. 計算の流れ（加工工賃のみ）

1. **曲げ**: 形状・重量・長さで CSV から基準価格を取得 → 数量スライド補正 → 小物割引（該当時）→ 下限300円適用 → 難易度・オプション加算（該当時）。
2. **穴あけ**: 上記 B の各項目を単価×個数で計算し合算。
3. **加工工賃合計（税抜）** = 曲げ + 穴あけ。税込は ×1.1 等で算出。

---

## 3. データソース・参照

| 用途 | パス・名前 |
|:---|:---|
| 曲げ価格表（CSV） | `src/data/bending_price_table.csv`（主）。同一内容: `data/曲げ価格表.csv` |
| 曲げ価格表（HTML内） | 定数 `BENDING_TABLE_V21`、長さ閾値 `LENGTH_THRESHOLDS_V21` = [835, 1670, 2505, 3048, 99999] |
| 形状マッピング（三方・四方→C型） | `shapeForV21(shape)` 等で「C型曲げ」に統一して表引き |
| 穴あけ（丸穴30φ以上） | `data/hole_prices.json` または HTML 内 `HOLE_MARU30_BY_T` |
| 穴あけ（ピアス板厚別） | HTML 内 `piercePriceV21(t)`（上記 B の表通り） |

---

## 4. 現行実装との対応（補足）

- **見積り計算書.html** には、本仕様の「加工工賃のみ」に相当するブロックとして **v2.1（加工工賃のみ）** がある。
- **曲げ**: 基準価格の表引き・数量スライド・小物割引・最低300円まで **実装済み**。中押し・逆曲げ・長尺目押し・深曲げ・干渉回避は **未実装**。
- **穴あけ**: 丸穴(30φ未満)・長穴・丸穴(30φ以上)・ポンチ・ピアスはいずれも **実装済み**。v2.1 表示では「穴あけ」は丸穴＋長穴をピアス単価で換算した参考表示。
- **本見積の見積合計** に効いている曲げは、いまは **メイン曲げ（kg単価×重量）**。本仕様 v3.0 どおりの「価格表ベースの曲げ」を見積合計に反映する場合は、v2.1 の曲げ結果を本見積に連携するか、メイン曲げを表引き＋係数＋固定費に差し替える設計が必要。

---

## 5. 用語・略称

| 用語 | 意味 |
|:---|:---|
| 長辺 | 曲げ加工時の長手方向。実装では max(縦+余長, 横+余長) を曲げ長さ・長辺に利用可。 |
| 重量 | 展開寸法×板厚×比重などで求めた計算用重量（kg）。 |
| 小計 | 曲げ基準価格に数量スライド補正を掛けた後の金額。 |

---

以上が、**曲げ加工見積もりシステム 実装仕様書 (v3.0)** の定義です。v3.0 を優先し、足りない部分は既存まとめ（曲げ工賃_まとめ.md）から補足しています。
