# 曲げ加工見積もりシステム 実装仕様書 (v2.1)

このドキュメントは、材料費を含まない**「純粋な加工工賃」**の見積もり計算ロジックを定義したものです。  
`bending_price_table.csv`（価格表）と板厚別ピアス単価を用いて実装する。

---

## 1. 計算ロジック詳細

### A. 曲げ加工費の計算 (Bending Cost)

CSV をベース価格とし、条件に応じて補正を行う。

1. **基準価格の取得**  
   入力された **形状・重量(kg)・長さ(mm)** に合致する価格を CSV から取得する。  
   - **重量**: 入力重量 ≤ テーブル重量 となる**最小**の行  
   - **長さ**: 入力長さ ≤ テーブル長さ となる**最小**の列  
   - CSV に該当重量がない場合（最大値超え）は、最大重量の価格を適用するか、エラーとする。

2. **数量スライド補正 (Volume Discount)**  
   製造個数（Lot）に応じて、基準価格に係数を掛ける。  
   - 1 〜 4個: × 1.5 （段取り負担増）  
   - 5 〜 19個: × 1.0 （標準）  
   - 20個以上: × 0.8 （量産割引）

3. **小物・軽量品割引 (Small Part Discount)**  
   以下の条件を**すべて**満たす場合、さらに割引を適用する。  
   - **条件**: 長辺 ≤ 300mm **かつ** 重量 ≤ 1.0kg  
   - **処理**: 小計 × 0.8 （ただし、曲げ工賃の**下限は 300円**とする）

4. **難易度・オプション加算 (Add-ons)**  
   - 中押し (Nakagoshi): × 1.5  
   - 逆曲げ (Reverse Bend): × 1.2  
   - 長尺目押し: 長さ ≥ 1000mm かつ目押し指定時 → **+2,500 円**  
   - 深曲げ・干渉回避: **+3,000 円**

---

### B. 穴あけ加工費 (Hole & Punch Cost)

穴あけコストは「穴の数」ではなく、**加工種別**と**板厚**で計算する。

1. **レーザーポンチ (Marking/Punch)**  
   - 単価: **30 円/個**（全板厚共通）  
   - マーキング、センターポンチ、ケガキ穴を含む。

2. **ピアス (Piercing)**  
   切断開始点（貫通）のコスト。板厚により変動する。  
   通常の「穴あけ（φ30未満）」は、基本的に「ピアス 1回」としてカウントする。

**ピアス単価テーブル**

| 板厚範囲 \(t\) | 単価 (円/個) |
| :--- | :--- |
| \(t \le 2.3\) | 30 |
| \(2.3 < t \le 4.5\) | 60 |
| \(4.5 < t \le 9.0\) | 100 |
| \(9.0 < t \le 12.0\) | 150 |
| \(12.0 < t\) | 200 |

---

## 2. 必要なデータファイル構成

- **src/data/bending_price_table.csv**  
  形状・重量範囲・長さクラス別の基準価格（CSV）。

---

## 3. 出力データ構造（JSON）

```json
{
  "total_estimate": {
    "processing_cost_tax_excluded": 0,
    "processing_cost_tax_included": 0
  },
  "breakdown": {
    "bending_cost": {
      "base_price": 0,
      "quantity_adjustment": 1.0,
      "complexity_adjustment": 1.0,
      "small_part_adjustment": 1.0,
      "total": 0
    },
    "hole_cost": {
      "punch_count": 0,
      "punch_price": 30,
      "pierce_count": 0,
      "pierce_price": 60,
      "total": 0
    }
  }
}
```

---

## 4. 実装場所

- **計算ロジック**: `src/calc_bending.py`  
- **価格表**: `src/data/bending_price_table.csv`  
- **CLI**: `python src/calc_bending.py --shape L曲げ --weight 5 --length 800 --long-side 400 --lot 10 --thickness 3.2 --pierce 4`
