# 曲げ工賃のまとめ（統合版）

見積り計算書の**曲げ工賃**について、**社長の価格表に基づく3段階ロジック**（Gemini まとめ）と、**現行HTMLの2系統の実装**を一つのドキュメントに統合したものです。材料費・切断費・穴あけは別項目のため扱いません。

---

## 1. 曲げ工賃の2系統（HTMLの構成）

| 系統 | 使う場所 | 計算の仕方 | 見積合計への反映 |
|:---|:---|:---|:---:|
| **メイン（本見積）** | 左「計算過程」の曲げ工賃・右「見積内訳」の曲げ工賃 | **曲げkg単価 × 重量**。kg単価は板厚別デフォルト or 手入力。U20/O20 は参考表示のみ。 | ✅ **する** |
| **v2.1（加工工賃のみ）** | 右パネル「加工工賃のみ（v2.1・材料費含まず）」 | **基準価格の表引き** → 数量係数 → 小物係数 → 最低300円。社長の価格表ロジックに相当。 | ❌ 参考表示のみ |

**見積合計に効いているのはメイン（kg単価×重量）**です。v2.1 は「価格表ベースの参考値」として別表示です。

---

## 2. 社長の価格表に基づく3段階ロジック（Gemini まとめ）

見積金額は次の **3段階** で決める、という整理です。

### 2.1 第1段階：基準価格の決定（表引き）

- **計算式ではなく**、社長が作成した**価格表（マトリックス）**から正解の数値を拾う。
- **入力**: 形状 × 製品重量 × 曲げ長さ
- **参照データ**: 工賃入力表 (2).csv 相当 → 実データは `data/曲げ価格表.csv` および HTML 内 `BENDING_TABLE_V21`。

**形状パターン（価格表の対応）**

| No. | 形状 |
|:---|:---|
| 1 | L曲げ（基準） |
| 2 | コの字曲げ / 3. Z曲げ |
| 4 | C型曲げ / 11. ハット曲げ |
| 5 | 三方曲げ / 8. 四方曲げ（※C型曲げとして同一行を参照） |

→ **実装**: v2.1 の `getBasePriceV21(shape, wt, lengthMm)` で表引き。メインの曲げ工賃は表引きを使わず kg単価×重量のみ。

---

### 2.2 第2段階：係数による補正（掛け率）

基準価格に対して、状況に応じた割り増し・割引を行う。

| 補正 | 条件・処理 | 実装状況 |
|:---|:---|:---:|
| **A. 数量（ロット）補正** | 1〜4個: ×1.5（段取り割増）／ 5〜19個: ×1.0／ 20個以上: ×0.8（量産割引） | ✅ v2.1 で実装（`quantityFactorV21`） |
| **B. 小物・軽量品割引** | 長辺300mm以下 **かつ** 重量1kg以下 → 合計から ×0.8。**ただし** 計算結果が300円を下回る場合は**最低料金300円**。 | ✅ v2.1 で実装（`smallF`、`Math.max(300, …)`） |
| **C. 難易度・特殊加工補正** | 中押し曲げ (Nakagoshi): ×1.5／ 逆曲げ (Reverse): ×1.2 | ❌ 未実装 |

→ メインの曲げ工賃には数量・小物の係数はなし。v2.1 のみ A・B を適用。

---

### 2.3 第3段階：固定費の加算（チャージ）

作業回数や手間賃を「プラス」する。

| チャージ | 内容 | 実装状況 |
|:---|:---|:---:|
| **長尺目押し** | 長さ1m以上で目押し指定の場合 **+2,500円** | ❌ 未実装 |
| **深曲げ・干渉回避** | **+3,000円** | ❌ 未実装 |

---

### 2.4 3段階ロジックの実装サマリ

| 項目 | メイン曲げ工賃 | v2.1 加工工賃のみ |
|:---|:---|:---|
| 基準価格（表引き） | 使わない（kg単価×重量） | ✅ 表引き（BENDING_TABLE_V21） |
| 数量補正 1.5/1.0/0.8 | なし | ✅ あり |
| 小物割引 ×0.8・最低300円 | なし | ✅ あり |
| 中押し ×1.5 | なし | ❌ 未実装 |
| 逆曲げ ×1.2 | なし | ❌ 未実装 |
| 長尺目押し +2,500円 | なし | ❌ 未実装 |
| 深曲げ・干渉回避 +3,000円 | なし | ❌ 未実装 |

---

## 3. メイン曲げ工賃（本見積に効く計算）

### 3.1 基本計算式

| 項目 | 式 |
|:---|:---|
| **1個あたり曲げ工賃** | **曲げkg単価（円/kg）× 重量（kg）** |
| **曲げ工賃（×数量）** | 1個あたり曲げ工賃 × 数量 |

- 重量は「展開寸法 × 板厚 × 比重」等の**計算用重量**（材料費と同じ値）。
- kg単価は**板厚別デフォルト** or **手入力**。↺で板厚別デフォルトに戻す。価格計算用_4の **J9 セル相当**。

### 3.2 板厚グループ（TG）と 20kg 境界

- **板厚**: 1.0, 1.2, 1.6, 2.3, 3.2, 4.5, 6.0, 9.0, 12.0, 16.0, 19.0 mm（数値入力時はこれらに正規化）。
- **板厚 → グループ**: `TG` で A〜E。参考テーブル（U20/O20）の参照に使用。

| グループ | 板厚（mm） |
|:---|:---|
| A | 1.0, 1.2, 1.6, 2.3 |
| B | 3.2, 4.5, 6.0 |
| C | 9.0, 12.0 |
| D | 16.0 |
| E | 19.0 |

- **重量 20kg**（`WT=20`）で計算方式が切り替わる。
  - **20kg未満**: 長さ区分ごとの**箇所単価**（円/箇所）× 曲げ回数（参考計算。採用額は kg単価×重量）。
  - **20kg以上**: **1曲げ 円/kg** と **追加 円/kg** の重量単価方式（同様に参考計算）。

### 3.3 曲げkg単価の板厚別デフォルト（円/kg）

| 板厚 | デフォルト kg単価 | 備考 |
|:---|:---|:---|
| 1.6, 2.3 | 185 | 薄板 |
| 3.2, 4.5 | 190 | 主力板厚 |
| 6.0 〜 19.0 | 185 | 6mm以上（価格計算用_4の530円再現のため185） |

- 実装: `getDefaultKgRate(t)`。経緯は「厚いほど単価が高く」なるよう 1.6/2.3→185・3.2/4.5→190・6mm以上→185 に変更済み。

### 3.4 形状別 曲げ回数（SB）

| 形状 | 曲げ回数 |
|:---|:---|
| L曲げ | 1 |
| Z曲げ・コの字曲げ | 2 |
| 三方曲げ | 3 |
| C型曲げ・四方曲げ・ハット曲げ | 4 |
| 手入力 | 画面上で指定 |

### 3.5 20kg未満：箇所単価（U20）— 参考用

- 長さ区分ごとに min/max 円。**箇所単価** = min ＋ (max−min)×min(横W/長さ区分, 1)。曲げ工賃（参考）= 箇所単価 × 曲げ回数。**採用額は kg単価×重量**。

### 3.6 20kg以上：重量単価（O20）— 参考用

- 1曲げ単価・追加単価を長さ区分で加算し、重量×曲げ回数で参考計算。**採用額は kg単価×重量**。

### 3.7 メインの計算の流れ

1. 板厚 → 正規化キー `t` → グループ `g = TG[t]`。
2. 重量 `wt`、横 `yo`、曲げ回数 `bends` を取得。
3. `calcM1(g, yo, wt, bends)` で参考計算（U20/O20）。
4. **採用 kg単価** = 未上書きなら `getDefaultKgRate(t)`、上書き中なら入力値。
5. **採用曲げ工賃** = kg単価 × 重量（`bendCost`）。これが見積合計に足される。

---

## 4. v2.1 曲げ工賃（価格表ベース・参考表示）

- **基準価格**: `getBasePriceV21(shape, wt, lengthMm)` で `BENDING_TABLE_V21` を参照。形状×重量帯×長さ区分（835/1670/2505/3048mm）。三方・四方は C型曲げとして同一行。
- **数量係数**: `quantityFactorV21(qty)` → 1〜4個 1.5、5〜19個 1.0、20個以上 0.8。
- **小物係数**: 長辺300mm以下かつ重量1kg以下 → 0.8、それ以外 1.0。
- **最低料金**: 曲げ工賃は `Math.max(300, 基準×数量係数×小物係数)`。
- データ: `data/曲げ価格表.csv` と HTML 内 `BENDING_TABLE_V21` は同一数値。

---

## 5. 画面での表示（曲げ工賃まわり）

| 場所 | 内容 |
|:---|:---|
| 計算過程「曲げ工賃（1:kg単価）」 | kg単価入力・↺・計算根拠（箇所単価 or 1曲げ/追加の内訳） |
| 計算過程「曲げ回数」・「板厚グループ」・「長さ区分」 | 形状・TG・U20/O20 に基づく表示 |
| 1個あたり合計・右「曲げ工賃」 | メインの曲げ工賃（kg単価×重量）×数量 |
| 右「kg単価+曲げ」・「切断費+曲げ」 | メイン曲げを使った合計（10円単位丸め） |
| 右「加工工賃のみ（v2.1）」 | 表引き＋数量＋小物＋最低300円の参考値 |

---

## 6. 参考テーブル・上書き・データ所在

- **参考テーブル**: 画面「参考: 単価テーブル（グループ〇）」で U20（20kg未満）・O20（20kg以上）を表示。使用中の長さ区分はハイライト。
- **上書き**: 曲げ kg単価は手入力で変更可。↺で板厚別デフォルトに戻す。重量欄の上書きは曲げ計算にも反映。
- **データ所在**: `TG`（板厚→グループ）、`U20`（20kg未満）、`O20`（20kg以上）、`SB`（形状→曲げ回数）、`WT`（20kg境界）、`getDefaultKgRate`、`calcM1`、`findCat`。v2.1 用: `BENDING_TABLE_V21`、`LENGTH_THRESHOLDS_V21`、`getBasePriceV21`、`quantityFactorV21`、`shapeForV21`。

---

## 7. 今後の拡張（3段階ロジックを完全に揃える場合）

- **未実装の補正・チャージ**: 中押し×1.5、逆曲げ×1.2、長尺目押し+2,500円、深曲げ・干渉回避+3,000円。v2.1 にチェックと係数/固定費を追加する形が自然。
- **見積合計を価格表ベースにしたい場合**: 見積合計に v2.1 の曲げを採用するか、メイン曲げを「表引き＋係数＋固定費」に差し替える設計が必要。

以上が、Gemini のまとめを踏まえた**曲げ工賃の統合まとめ**です。
